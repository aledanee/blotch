<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login and Fetch User Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 900px;
            margin: auto;
        }

        .article {
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        .article img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }

        .article h2 {
            font-size: 1.5rem;
        }

        .article p {
            font-size: 1rem;
        }

        .article-info {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Login</h2>
        <form id="loginForm">
            <div class="mb-3">
                <label for="email" class="form-label">Email address</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
        </form>

        <div id="userData" style="margin-top: 20px; display:none;">
            <h3>User Data</h3>
            <p><strong>Username:</strong> <span id="username"></span></p>
        </div>

        <h2>Articles</h2>

        <div class="search">
            <input type="text" id="searchInput" class="form-control" placeholder="Search for articles...">
            <button id="searchBtn" class="btn btn-primary mt-2">Search</button>
        </div>

        <div class="articles" id="articlesContainer" style="margin-top: 20px;"></div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const apiBaseUrl = 'http://127.0.0.1:8001/v1';  // Make sure apiBaseUrl is declared here

        document.getElementById('loginForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            axios.post(`${apiBaseUrl}/token`, new URLSearchParams({
                username: email,
                password: password
            }), {
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            })
            .then(function (response) {
                const accessToken = response.data.access_token;
                console.log('Access Token:', accessToken);

                // Fetch user data with the obtained access token
                axios.get(`${apiBaseUrl}/users/me/`, {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                })
                .then(function (response) {
                    const userData = response.data;
                    console.log('User Data:', userData);

                    // Display user data on the page
                    document.getElementById('username').textContent = userData.username;
                    document.getElementById('userData').style.display = 'block';

                    // Load articles after login
                    loadArticles(accessToken);
                })
                .catch(function (error) {
                    console.error('Failed to fetch user data:', error);
                });
            })
            .catch(function (error) {
                console.error('Login failed:', error);
                alert('Login failed. Please check your email and password.');
            });
        });

        function loadArticles(accessToken, query = '') {
            const url = query ? `${apiBaseUrl}/search/articles?search=${query}` : `${apiBaseUrl}/search/articles`;

            axios.get(url, {
                headers: {
                    Authorization: `Bearer ${accessToken}`
                }
            })
            .then(function (response) {
                displayArticles(response.data);
            })
            .catch(function (error) {
                console.error('Failed to load articles:', error);
                alert('Failed to load articles.');
            });
        }

        function displayArticles(articles) {
            const articlesContainer = document.getElementById('articlesContainer');
            articlesContainer.innerHTML = '';

            articles.forEach(article => {
                const articleElement = document.createElement('div');
                articleElement.className = 'article';

                articleElement.innerHTML = `
                    <h2>${article.title}</h2>
                    <img src="${article.image_url}" alt="${article.title}">
                    <p>${article.text.slice(0, 100)}...</p>
                    <div class="article-info">
                        <p>Date: ${new Date(article.created_at).toLocaleDateString()}</p>
                        <p>Category ID: ${article.category_id} | Read Time: ${article.read_time} mins | Views: ${article.views}</p>
                    </div>
                    <button class="btn btn-primary" onclick="viewArticle(${article.id})">Read More</button>
                `;

                articlesContainer.appendChild(articleElement);
            });
        }

        document.getElementById('searchBtn').addEventListener('click', function () {
            const query = document.getElementById('searchInput').value;
            const accessToken = localStorage.getItem('access_token');
            loadArticles(accessToken, query);
        });

        function viewArticle(articleId) {
            console.log(`Viewing article with ID: ${articleId}`);
            // Implement the article detail view here
        }
    </script>
</body>
</html>
